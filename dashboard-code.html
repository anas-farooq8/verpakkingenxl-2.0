<script>
    // Data injected by n8n
    window.kvsDataFromN8n = {{ JSON.stringify($('Aggregate KVS').item.json.data) }};
    window.zendeskDataFromN8n = {{ JSON.stringify($('Aggregate Customer Data').item.json.data) }};
</script>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VerpakkingenXL Lead Import Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 36px;
            color: #2c3e50;
            font-weight: 700;
        }

        /* Tabs */
        .tabs-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .tabs-header {
            display: flex;
            border-bottom: 2px solid #e3f2fd;
            background: #f8f9fa;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-btn:hover {
            background: #e3f2fd;
            color: #2c3e50;
        }

        .tab-btn.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 25px;
        }

        .tab-content.active {
            display: block;
        }

        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #2980b9;
        }

        .refresh-btn::before {
            content: "‚ü≥";
            font-size: 18px;
        }

        .data-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .data-header h2 {
            font-size: 20px;
            color: #2c3e50;
        }

        .import-btn {
            display: inline-block;
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .import-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .import-btn.excel-btn {
            background: #27ae60;
        }

        .import-btn.excel-btn:hover {
            background: #229954;
        }

        input[type="file"] {
            display: none;
        }

        .loading {
            display: none;
            margin: 20px 0;
            text-align: center;
            color: #7f8c8d;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ecf0f1;
            border-top-color: #5b9bd5;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .refresh-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
        }

        .results-count {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }

        /* Filters */
        .filters-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .filters-section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-item.reset-actions {
            display: flex;
            justify-content: flex-end;
            align-items: flex-end;
            grid-column: -1;
        }

        @media (min-width: 1200px) {
            .filters-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        .filter-item {
            display: flex;
            flex-direction: column;
        }

        .filter-item label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #555;
            font-size: 14px;
        }

        .filter-item input,
        .filter-item select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .filter-item select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%23333" d="M6 9L1 4h10z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 35px;
        }

        .range-slider {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .range-value {
            font-weight: 600;
            color: #3498db;
            min-width: 40px;
        }

        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sort-controls label {
            font-weight: 600;
            color: #555;
        }

        .sort-controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%23333" d="M6 9L1 4h10z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 35px;
        }

        .sort-btn {
            background: #ecf0f1;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .sort-btn:hover {
            background: #bdc3c7;
        }

        .reset-filters-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            transition: background 0.3s;
        }

        .reset-filters-btn:hover {
            background: #c0392b;
        }

        .discard-btn {
            background: #7f8c8d;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            transition: background 0.3s;
        }

        .discard-btn:hover {
            background: #646f73;
        }

        .save-processing-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            transition: background 0.3s;
        }

        .save-processing-btn:hover:not(:disabled) {
            background: #229954;
        }

        .save-processing-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            opacity: 0.8;
        }

        .save-kvs-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 14px 40px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            min-width: 150px;
        }

        .save-kvs-btn:hover:not(:disabled) {
            background: #229954;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
        }

        .save-kvs-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* KVS layout */
        .kvs-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .kvs-item {
            display: flex;
            flex-direction: column;
        }

        .kvs-item label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 15px;
        }

        .kvs-item input,
        .kvs-item textarea {
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            transition: border-color 0.3s;
            background: #f8f9fa;
        }

        .kvs-item textarea {
            resize: vertical;
            min-height: 220px;
            line-height: 1.6;
        }

        .kvs-item input:focus,
        .kvs-item textarea:focus {
            outline: none;
            border-color: #3498db;
            background: white;
        }

        .kvs-item.limit-item input {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        .import-btn.disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .error {
            display: none;
            padding: 15px;
            background: #e74c3c;
            color: white;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .error.active {
            display: block;
        }

        .table-container {
            display: none;
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .table-container.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
        }

        th {
            text-align: left;
            padding: 12px;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        tbody tr {
            cursor: pointer;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 16px;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 25px;
            padding: 20px;
        }

        .pagination-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 40px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .pagination-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .pagination-info {
            color: #666;
            font-size: 14px;
            font-weight: 600;
            padding: 0 15px;
        }

        .null-value {
            color: #95a5a6;
            font-style: italic;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        /* Status & Badge Components */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-queued {
            background: #fff3cd;
            color: #856404;
        }

        .status-processed {
            background: #d4edda;
            color: #155724;
        }

        .lead-score {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 600;
            background: #e3f2fd;
            color: #1976d2;
        }

        .deal-link {
            color: #3498db;
            text-decoration: underline;
            font-weight: 600;
            cursor: pointer;
        }

        .deal-link:hover {
            color: #2980b9;
        }

        .push-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .push-btn:hover {
            background: #229954;
        }

        .push-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .pushed-badge {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Modal Components */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 25px;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-section {
            margin-bottom: 25px;
        }

        .modal-section h3 {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e3f2fd;
        }

        .modal-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .modal-field {
            display: flex;
            flex-direction: column;
        }

        .modal-field.full-width {
            grid-column: 1 / -1;
        }

        .modal-field label {
            font-weight: 600;
            color: #555;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .modal-field .value {
            color: #333;
            font-size: 14px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .modal-field .value.long-text {
            white-space: pre-wrap;
            line-height: 1.6;
        }

        /* ===========================
           Login Screen
        =========================== */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #2c5aa0 0%, #1a3d6b 100%);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            height: auto;
            min-height: auto;
        }

        .login-box h2 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 24px;
            text-align: center;
            font-weight: 700;
        }

        .login-box p {
            margin: 0 0 25px 0;
            color: #666;
            text-align: center;
            font-size: 14px;
        }

        .password-input-wrapper {
            position: relative;
            margin-bottom: 15px;
            display: block;
            width: 100%;
        }

        .password-input-wrapper input {
            width: 100%;
            padding: 12px 45px 12px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s;
            display: block;
            height: auto;
            background: white;
            color: #333;
        }

        .password-input-wrapper input:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            color: #333;
        }

        .password-input-wrapper input.error {
            border-color: #e74c3c;
            background: white;
            color: #333;
            animation: shake 0.4s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .toggle-password {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: color 0.3s;
        }

        .toggle-password:hover {
            color: #3498db;
        }

        .toggle-password svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .login-box > button {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 0;
            margin-bottom: 0;
            display: block;
        }

        .login-box > button:hover {
            background: #2980b9;
        }

        .login-box > button:active {
            transform: scale(0.98);
        }

        .login-error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 15px;
            padding: 12px;
            background: #fee;
            border: 1px solid #e74c3c;
            border-radius: 6px;
            display: none;
            align-items: center;
            gap: 8px;
            width: 100%;
            box-sizing: border-box;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-error.show {
            display: flex;
        }

        .login-error svg {
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .data-section {
                padding: 20px;
            }

            table {
                font-size: 12px;
            }

            th,
            td {
                padding: 8px;
            }

            .modal-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <!-- SheetJS library for Excel parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>

<body>
    <!-- Login Screen -->
    <div class="login-overlay" id="login_overlay">
        <div class="login-box">
            <h2>üîí VerpakkingenXL Lead Dashboard</h2>
            <p>Enter passcode to access dashboard</p>
            <div class="password-input-wrapper">
                <input type="password" id="login_password" placeholder="Enter passcode" autocomplete="off">
                <button type="button" class="toggle-password" onclick="auth.togglePassword()" aria-label="Toggle password visibility">
                    <svg id="eye_icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
            </div>
            <button type="button" onclick="auth.login()">Access Dashboard</button>
            <div class="login-error" id="login_error">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                <span>Invalid passcode. Please try again.</span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üöö VerpakkingenXL Lead Import Dashboard</h1>
            <button class="refresh-btn" id="refreshBtn">Refresh</button>
        </div>

            <div class="tabs-container">
                <div class="tabs-header">
                    <button class="tab-btn active" data-tab="dashboard" onclick="switchTab('dashboard')">üìä Dashboard</button>
                    <button class="tab-btn" data-tab="kvs" onclick="switchTab('kvs')">‚öôÔ∏è KVS Configuration</button>
                    <button class="tab-btn" data-tab="import" onclick="switchTab('import')">üì• Import Data</button>
                </div>

                <!-- Dashboard Tab -->
                <div id="tab-dashboard" class="tab-content active">
                    <!-- Filters Section -->
                    <div class="filters-section" id="dashboardFiltersSection">
                        <h2>Filters</h2>
                        <div class="filters-grid">
                            <div class="filter-item">
                                <label for="dashboardSearch">Search</label>
                                <input type="text" id="dashboardSearch" placeholder="Name, Email, Phone...">
                            </div>
                            <div class="filter-item">
                                <label for="dashboardStatus">Status</label>
                                <select id="dashboardStatus">
                                    <option value="all">All</option>
                                    <option value="queued">Queued</option>
                                    <option value="processed">Processed</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label for="dashboardSource">Source</label>
                                <select id="dashboardSource">
                                    <option value="all">All</option>
                                    <option value="zendesk">Zendesk</option>
                                    <option value="erp">ERP</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label for="dashboardShippingVolume">Estimated Shipping Volume</label>
                                <select id="dashboardShippingVolume">
                                    <option value="all">All</option>
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label for="dashboardLogisticsType">Logistics Type</label>
                                <select id="dashboardLogisticsType">
                                    <option value="all">All</option>
                                    <option value="parcels">Parcels</option>
                                    <option value="pallets">Pallets</option>
                                    <option value="both">Both</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label>Lead Score Range: <span class="range-value" id="dashboardScoreDisplay">0.0 - 10.0</span></label>
                                <div class="range-slider">
                                    <input type="number" id="dashboardScoreMin" min="0" max="10" step="0.1" value="0" style="width: 80px;">
                                    <span>to</span>
                                    <input type="number" id="dashboardScoreMax" min="0" max="10" step="0.1" value="10" style="width: 80px;">
                                </div>
                            </div>
                            <div class="filter-item reset-actions">
                                <button class="reset-filters-btn" id="dashboardResetFiltersBtn">‚úï Reset Filters</button>
                            </div>
                        </div>
                    </div>

                    <div class="data-section">
                        <div class="data-header">
                            <h2>Zendesk Leads</h2>
                            <div class="sort-controls">
                                <label>Sort by:</label>
                                <select id="dashboardSortField">
                                    <option value="createdAt">Created Date</option>
                                    <option value="lead_score">Lead Score</option>
                                </select>
                                <button class="sort-btn" id="dashboardSortBtn">
                                    <span id="dashboardSortDirection">‚Üì</span>
                                </button>
                            </div>
                        </div>
                        <div class="results-count" id="dashboardResultsCount">No data available</div>
                        <div class="table-container active">
                            <table id="dashboardTable">
                                <thead>
                                    <tr>
                                        <th>Customer Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Shipping Vol.</th>
                                        <th>Logistics</th>
                                        <th>Lead Score</th>
                                        <th>Source</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th id="orgIdHeader" style="display: none;">Org ID</th>
                                        <th id="personIdHeader" style="display: none;">Person ID</th>
                                        <th id="dealIdHeader" style="display: none;">Deal ID</th>
                                        <th id="pushHeader" style="display: none;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="dashboardTableBody">
                                    <tr>
                                        <td colspan="13" class="no-results">No data available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination-container" id="dashboardPaginationContainer" style="display: none;">
                            <button class="pagination-btn" id="dashboardFirstBtn">¬´¬´</button>
                            <button class="pagination-btn" id="dashboardPrevBtn">¬´</button>
                            <span class="pagination-info" id="dashboardPageInfo">Page 1 of 1</span>
                            <button class="pagination-btn" id="dashboardNextBtn">¬ª</button>
                            <button class="pagination-btn" id="dashboardLastBtn">¬ª¬ª</button>
                        </div>
                    </div>
                </div>

                <!-- Import Data Tab -->
                <div id="tab-import" class="tab-content">
                    <div class="data-section">
                        <div class="data-header">
                            <h2>Customers</h2>
                            <div style="display: flex; gap: 10px;">
                                <label for="fileInput" class="import-btn" id="importBtn">Import Zendesk JSONL File</label>
                                <input type="file" id="fileInput" accept=".jsonl,.json" style="display: none;">
                                <label for="excelFileInput" class="import-btn excel-btn" id="importExcelBtn">Import Custom ERP Excel File</label>
                                <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;">
                            </div>
                        </div>

                        <div class="loading" id="loading"
                            style="display: none; text-align: center; margin: 20px 0; color: #7f8c8d;">
                            <span class="spinner"></span>
                            <span style="margin-left: 10px;">Parsing file...</span>
                        </div>

                        <div class="error" id="error"
                            style="display: none; padding: 15px; background: #e74c3c; color: white; border-radius: 4px; margin-bottom: 20px;">
                        </div>

                        <!-- Filters -->
                        <div class="filters-section" id="filtersSection">
                            <h3>Filters</h3>
                            <div class="filters-grid">
                                <div class="filter-item">
                                    <label for="searchQuery">Search</label>
                                    <input type="text" id="searchQuery" placeholder="Search by name or email...">
                                </div>
                                <div class="filter-item">
                                    <button class="reset-filters-btn" id="resetFiltersBtn">‚úï Reset Filters</button>
                                </div>
                                <div class="filter-item">
                                    <button class="discard-btn" id="discardBtn">Discard Data</button>
                                </div>
                                <div class="filter-item">
                                    <button class="save-processing-btn" id="saveProcessingBtn">Save data for processing</button>
                                </div>
                            </div>
                        </div>

                        <div class="results-count" id="resultsCount">No data loaded</div>

                        <div class="table-container" id="importTableContainer">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Address</th>
                                        <th>Locale</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    <tr>
                                        <td colspan="7" class="no-results">No data loaded. Please import a file.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div class="pagination-container" id="paginationContainer" style="display: none;">
                            <button class="pagination-btn" id="firstBtn">¬´¬´</button>
                            <button class="pagination-btn" id="prevBtn">¬´</button>
                            <span class="pagination-info" id="pageInfo">Page 1 of 1</span>
                            <button class="pagination-btn" id="nextBtn">¬ª</button>
                            <button class="pagination-btn" id="lastBtn">¬ª¬ª</button>
                        </div>
                    </div>
                </div>

                <!-- KVS Configuration Tab -->
                <div id="tab-kvs" class="tab-content">
                    <h2 style="margin-bottom: 25px; color: #2c3e50; font-size: 24px;">‚öôÔ∏è KVS Configuration</h2>

                    <div class="kvs-grid">
                        <div class="kvs-item">
                            <label for="system_prompt_base_agent">üìù System Prompt - Base Agent</label>
                            <textarea id="system_prompt_base_agent"
                                placeholder="Enter the system prompt for the base agent..."></textarea>
                        </div>

                        <div class="kvs-item">
                            <label for="system_prompt_web_search_agent">üîç System Prompt - Web Search Agent</label>
                            <textarea id="system_prompt_web_search_agent"
                                placeholder="Enter the system prompt for the web search agent..."></textarea>
                        </div>

                        <div class="kvs-item limit-item">
                            <label for="daily_processing_limit">üìÖ Hourly Lead Processing Limit</label>
                            <input type="number" id="daily_processing_limit" placeholder="Enter hourly processing limit...">
                        </div>
                    </div>

                    <button class="save-kvs-btn" id="save-kvs-btn">
                        <span id="save-btn-text">üíæ Save Configuration</span>
                    </button>
                </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModalOnOverlay(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalTitle">Lead Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // Authentication Module
        // ============================================
        const auth = (() => {
            const PASSWORD_HASH = '7f97f29af8b5c9b9af787b8dec539cde58bd6fd75c6494586f34570747425424';
            let sessionToken = null;

            // Generate a random 256-bit session token
            function generateSessionToken() {
                const array = new Uint8Array(32); // 256 bits
                crypto.getRandomValues(array);
                return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            }

            // Hash password with SHA-256
            async function hashPassword(password) {
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }

            // Check if currently logged in
            function isLoggedIn() {
                // Check if hash matches our current session token
                if (sessionToken && window.location.hash === `#${sessionToken}`) {
                    return true;
                }
                return false;
            }

            // Log out user
            function logout() {
                sessionToken = null;
                window.location.hash = '';
            }

            // Initialize session token from URL hash on page load
            function initSession() {
                const hash = window.location.hash.substring(1);
                if (hash && hash.length === 64) { // Valid 256-bit hex token
                    sessionToken = hash;
                }
            }

            function togglePassword() {
                const passwordInput = document.getElementById('login_password');
                const eyeIcon = document.getElementById('eye_icon');
                
                if (!passwordInput || !eyeIcon) return;
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    eyeIcon.setAttribute('fill', 'none');
                    eyeIcon.setAttribute('stroke', 'currentColor');
                    eyeIcon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
                } else {
                    passwordInput.type = 'password';
                    eyeIcon.setAttribute('fill', 'none');
                    eyeIcon.setAttribute('stroke', 'currentColor');
                    eyeIcon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
                }
            }

            async function login() {
                const passwordInput = document.getElementById('login_password');
                const errorMsg = document.getElementById('login_error');
                
                if (!passwordInput || !errorMsg) return;
                
                const password = passwordInput.value;

                errorMsg.classList.remove('show');
                passwordInput.classList.remove('error');

                if (!password) {
                    errorMsg.querySelector('span').textContent = 'Please enter a passcode.';
                    errorMsg.classList.add('show');
                    passwordInput.classList.add('error');
                    passwordInput.focus();
                    return;
                }

                const hash = await hashPassword(password);
                
                if (hash === PASSWORD_HASH) {
                    // Generate new random session token
                    sessionToken = generateSessionToken();
                    window.location.hash = sessionToken;
                    
                    document.getElementById('login_overlay').classList.add('hidden');
                    errorMsg.classList.remove('show');
                    initializeApp();
                } else {
                    errorMsg.querySelector('span').textContent = 'Invalid passcode. Please try again.';
                    errorMsg.classList.add('show');
                    passwordInput.classList.add('error');
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            }

            function checkAuth() {
                initSession(); // Load session token from URL hash
                
                if (isLoggedIn()) {
                    document.getElementById('login_overlay').classList.add('hidden');
                    return true;
                }
                return false;
            }

            // Allow Enter key to submit
            document.addEventListener('DOMContentLoaded', () => {
                const passwordInput = document.getElementById('login_password');
                if (passwordInput) {
                    passwordInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') login();
                    });
                    passwordInput.focus();
                }
            });

            return { 
                login, 
                checkAuth, 
                togglePassword,
                isLoggedIn,
                logout
            };
        })();
        
        // Make auth globally accessible for inline onclick handlers
        window.auth = auth;

        // ============================================
        // Application Initialization
        // ============================================
        function initializeApp() {
            // Initialize KVS data
            populateKVS();
            
            // Initialize dashboard
            initializeDashboard();
            updateDashboardScoreDisplay();
        }

        // Global state
        let allUsers = [];
        let currentPage = 1;
        const itemsPerPage = 20;
        let kvsFieldsEdited = false;

        const BLOCKLIST_BASE_DOMAINS = [
            // A. Free Email Providers
            'gmail',
            'googlemail',
            'google',
            'hotmail',
            'outlook',
            'live',
            'msn',
            'yahoo',
            'aol',
            'icloud',
            'me',
            'mac',
            'protonmail',
            'mail',
            'foxmail',
            '163',
            'vip',
            'yeah',
            'yandex',
            'rambler',
            'qq',
            'web',

            // B. ISP / Telecom Providers
            'ziggo',
            'kpnmail',
            'kpnplanet',
            'planet',
            'home',
            'upcmail',
            'xs4all',
            'hetnet',
            'chello',
            'quicknet',
            'casema',
            'telfort',
            'zeelandnet',
            'telenet',
            'skynet',
            'caiway',
            'solcon',
            'online',
            'zonnet',
            'kabelfoon',
            'scarlet',
            'proximus',
            'tele2',
            'onsbrabantnet',
            't-mobilethuis',
            'wxs',
            'hccnet',
            'kliksafe',

            // C. Suspicious
            'bagat-1',
            'bagat-2',
            'bagat-3',
            'bagat-4',
            'expl0it',
            'bobbor',
            'atrimoney',

            // D. Marketplace / Notifications
            'partnerplatform',
            'verkopen',
            'klantbericht',
            'mail.marktplaats',
            'edm.postnl',

            // E. Routing / Bulk Senders
            'gls-netherlands',
            'course-fitness',
        ];

        // DOM elements
        const fileInput = document.getElementById('fileInput');
        const excelFileInput = document.getElementById('excelFileInput');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const resultsCount = document.getElementById('resultsCount');
        const tableBody = document.getElementById('tableBody');
        const tableContainer = document.getElementById('importTableContainer');
        const paginationContainer = document.getElementById('paginationContainer');
        const pageInfo = document.getElementById('pageInfo');
        const firstBtn = document.getElementById('firstBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const lastBtn = document.getElementById('lastBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const importBtn = document.getElementById('importBtn');
        const importExcelBtn = document.getElementById('importExcelBtn');
        const filtersSection = document.getElementById('filtersSection');
        const searchInput = document.getElementById('searchQuery');
        const resetFiltersBtn = document.getElementById('resetFiltersBtn');
        const discardBtn = document.getElementById('discardBtn');
        const saveProcessingBtn = document.getElementById('saveProcessingBtn');
        const saveKvsBtn = document.getElementById('save-kvs-btn');
        const saveKvsBtnText = document.getElementById('save-btn-text');

        const SAVE_WEBHOOK_URL = 'https://your-n8n-domain/webhook/save-raw-data';
        const KVS_WEBHOOK_URL = 'https://your-n8n-domain/webhook/update-kvs-2.0';
        const PUSH_WEBHOOK_URL = 'https://your-n8n-domain/webhook/push-to-pipedrive';

        const KVS_FIELDS = [
            { id: 'system_prompt_base_agent', key: 'system_prompt_base_agent' },
            { id: 'system_prompt_web_search_agent', key: 'system_prompt_web_search_agent' },
            { id: 'daily_processing_limit', key: 'daily_processing_limit' }
        ];

        // UI state helpers
        const showLoading = () => loading.style.display = 'block';
        const hideLoading = () => loading.style.display = 'none';
        
        const showError = (message) => {
            error.textContent = message;
            error.style.display = 'block';
        };
        
        const hideError = () => error.style.display = 'none';
        const showResults = () => {
            tableContainer.classList.add('active');
            paginationContainer.style.display = 'flex';
            filtersSection.style.display = 'block';
        };
        
        const hideResults = () => {
            tableContainer.classList.remove('active');
            paginationContainer.style.display = 'none';
            filtersSection.style.display = 'none';
            tableBody.innerHTML = '<tr><td colspan="7" class="no-results">No data loaded. Please import a file.</td></tr>';
            resultsCount.textContent = 'No data loaded';
        };

        // Hide filters and results on initial load until data is imported
        hideResults();

        // Helpers for email/domain filtering
        function getEmailDomain(email) {
            if (!email || typeof email !== 'string') return null;
            const atIndex = email.lastIndexOf('@');
            if (atIndex === -1) return null;
            const domain = email.slice(atIndex + 1).toLowerCase().trim();
            return domain || null;
        }

        function isBlockedEmailDomain(email) {
            const domain = getEmailDomain(email);
            if (!domain) return false;
            
            // Check base provider label only (e.g. hotmail.*, yahoo.*, outlook.*)
            const parts = domain.split('.');
            if (parts.length === 0) return false;
            const provider = parts[0];
            return BLOCKLIST_BASE_DOMAINS.includes(provider);
        }

        // Helpers for name/email filters
        function getFilteredUsers() {
            if (!allUsers.length) return [];

            const query = searchInput.value.trim().toLowerCase();

            if (!query) {
                return allUsers;
            }

            return allUsers.filter(user => {
                const name = (user.name || '').toLowerCase();
                const email = (user.email || '').toLowerCase();

                return name.includes(query) || email.includes(query);
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Reset state
            allUsers = [];
            currentPage = 1;
            hideError();
            hideResults();
            showLoading();

            // Read and parse file
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    parseJSONL(e.target.result);
                } catch (err) {
                    allUsers = [];
                    fileInput.value = '';
                    showError('Failed to parse file: ' + err.message);
                    hideLoading();
                }
            };
            reader.onerror = () => {
                allUsers = [];
                fileInput.value = '';
                showError('Failed to read file');
                hideLoading();
            };
            reader.readAsText(file);
        }

        // Parse JSONL content
        function parseJSONL(content) {
            const lines = content.split('\n');
            const tempUsers = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                try {
                    const rawUser = JSON.parse(line);

                    // Skip users with blocked email domains
                    if (isBlockedEmailDomain(rawUser.email)) {
                        continue;
                    }

                    // Keep only the fields that are displayed in the table
                    tempUsers.push({
                        id: rawUser.id,
                        name: rawUser.name,
                        email: rawUser.email,
                        phone: rawUser.phone,
                        address: null,
                        locale: rawUser.locale,
                        source: 'zendesk'
                    });
                } catch (err) {
                    hideLoading();
                    allUsers = [];
                    fileInput.value = '';
                    showError(`Parsing error at line ${i + 1}: ${err.message}. File discarded.`);
                    return;
                }
            }

            hideLoading();

            if (tempUsers.length === 0) {
                allUsers = [];
                fileInput.value = '';
                showError('No valid user records found in file. File discarded.');
                return;
            }

            // Success - commit the data
            allUsers = tempUsers;

            // Disable both import buttons while data is loaded
            importBtn.classList.add('disabled');
            importBtn.style.pointerEvents = 'none';
            importExcelBtn.classList.add('disabled');
            importExcelBtn.style.pointerEvents = 'none';

            // Show results
            renderTable();
            showResults();
        }

        // Handle Excel file selection
        function handleExcelFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            hideError();
            hideResults();
            showLoading();

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    parseExcel(e.target.result);
                } catch (err) {
                    allUsers = [];
                    excelFileInput.value = '';
                    showError('Failed to parse Excel file: ' + err.message);
                    hideLoading();
                }
            };
            reader.onerror = () => {
                allUsers = [];
                excelFileInput.value = '';
                showError('Failed to read Excel file');
                hideLoading();
            };
            reader.readAsArrayBuffer(file);
        }

        // Parse Excel content
        function parseExcel(data) {
            try {
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                const tempUsers = [];

                for (let i = 0; i < jsonData.length; i++) {
                    const row = jsonData[i];

                    // Map Excel columns to our data structure
                    const klantCode = row['Klant code'] || row['Klant code'] || '';
                    const klant = row['Klant'] || '';
                    const adresregels = row['Adresregels'] || '';
                    const postcode = row['Postcode'] || '';
                    const plaats = row['Plaats'] || '';
                    const provincie = row['Provincie'] || '';
                    const land = row['Land'] || '';

                    // Skip rows without required data
                    if (!klantCode || !klant) {
                        continue;
                    }

                    // Construct address from components
                    const addressParts = [adresregels, postcode, plaats, provincie, land].filter(part => part);
                    const address = addressParts.length > 0 ? addressParts.join(', ') : '-';

                    tempUsers.push({
                        id: String(klantCode).trim(),
                        name: String(klant).trim(),
                        email: null,
                        phone: null,
                        address: address,
                        locale: null,
                        source: 'erp'
                    });
                }

                hideLoading();

                if (tempUsers.length === 0) {
                    allUsers = [];
                    excelFileInput.value = '';
                    showError('No valid records found in Excel file. File discarded.');
                    return;
                }

                // Success - commit the data
                allUsers = tempUsers;

                // Disable import while data is loaded
                importBtn.classList.add('disabled');
                importBtn.style.pointerEvents = 'none';
                importExcelBtn.classList.add('disabled');
                importExcelBtn.style.pointerEvents = 'none';

                // Show results
                renderTable();
                showResults();
            } catch (err) {
                hideLoading();
                allUsers = [];
                excelFileInput.value = '';
                showError('Error parsing Excel file: ' + err.message);
            }
        }

        // Render table for current page
        function renderTable() {
            if (allUsers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="no-results">No users to display.</td></tr>';
                resultsCount.textContent = 'No users to display';
                paginationContainer.style.display = 'none';
                return;
            }

            const visibleUsers = getFilteredUsers();

            if (visibleUsers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="no-results">No users match the current filters.</td></tr>';
                resultsCount.textContent = 'Showing 0 of ' + allUsers.length + ' users';
                paginationContainer.style.display = 'none';
                return;
            }

            const totalPages = Math.ceil(visibleUsers.length / itemsPerPage);
            if (currentPage > totalPages) {
                currentPage = totalPages || 1;
            }

            const startIndex = (currentPage - 1) * itemsPerPage;
            const pageUsers = visibleUsers.slice(startIndex, startIndex + itemsPerPage);

            const rows = pageUsers.map((user) => {
                return `<tr>
                    <td>${formatValue(user.id)}</td>
                    <td>${formatValue(user.name)}</td>
                    <td>${formatValue(user.email)}</td>
                    <td>${formatValue(user.phone)}</td>
                    <td>${formatValue(user.address)}</td>
                    <td>${formatValue(user.locale)}</td>
                    <td><button class="delete-btn" onclick="deleteUser('${String(user.id)}')">Delete</button></td>
                </tr>`;
            });

            tableBody.innerHTML = rows.join('');
            updatePagination();
        }

        // Format table cell values
        function formatValue(value) {
            if (value === null || value === undefined || value === '') {
                return '<span class="null-value">‚Äî</span>';
            }
            return typeof value === 'boolean' ? (value ? 'Yes' : 'No') : String(value);
        }

        // Update pagination controls
        function updatePagination() {
            const visibleUsers = getFilteredUsers();

            if (visibleUsers.length === 0) {
                pageInfo.textContent = 'Page 0 of 0';
                resultsCount.textContent = 'Showing 0 of ' + allUsers.length + ' users';
                firstBtn.disabled = prevBtn.disabled = true;
                nextBtn.disabled = lastBtn.disabled = true;
                return;
            }

            const totalPages = Math.ceil(visibleUsers.length / itemsPerPage);
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = Math.min(startIdx + itemsPerPage, visibleUsers.length);

            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            resultsCount.textContent = `Showing ${startIdx + 1}-${endIdx} of ${visibleUsers.length} users (${allUsers.length} total)`;

            const isFirstPage = currentPage === 1;
            const isLastPage = currentPage === totalPages;

            firstBtn.disabled = prevBtn.disabled = isFirstPage;
            nextBtn.disabled = lastBtn.disabled = isLastPage;
        }

        // Pagination handlers
        const goToPage = (pageNumber) => {
            const visibleUsers = getFilteredUsers();
            const totalPages = Math.ceil(visibleUsers.length / itemsPerPage) || 1;
            if (pageNumber >= 1 && pageNumber <= totalPages) {
                currentPage = pageNumber;
                renderTable();
            }
        };

        firstBtn.addEventListener('click', () => goToPage(1));
        prevBtn.addEventListener('click', () => goToPage(currentPage - 1));
        nextBtn.addEventListener('click', () => goToPage(currentPage + 1));
        lastBtn.addEventListener('click', () => {
            const visibleUsers = getFilteredUsers();
            const totalPages = Math.ceil(visibleUsers.length / itemsPerPage) || 1;
            goToPage(totalPages);
        });

        // Delete user function
        function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user entry?')) return;

            const idStr = String(userId);
            allUsers = allUsers.filter(u => String(u.id) !== idStr);

            if (allUsers.length === 0) {
                currentPage = 1;
                hideResults();
                return;
            }
            
            // Adjust current page if needed
            const totalPages = Math.ceil(allUsers.length / itemsPerPage);
            if (currentPage > totalPages) currentPage = totalPages;
            
            renderTable();
        }

        // Refresh data
        const refreshData = () => {
            location.reload();
        };

        // Event listeners
        fileInput.addEventListener('change', handleFileSelect);
        excelFileInput.addEventListener('change', handleExcelFileSelect);
        refreshBtn.addEventListener('click', refreshData);
        searchInput.addEventListener('input', () => {
            currentPage = 1;
            renderTable();
        });
        resetFiltersBtn.addEventListener('click', () => {
            searchInput.value = '';
            currentPage = 1;
            renderTable();
        });

        function resetUI() {
            allUsers = [];
            currentPage = 1;
            fileInput.value = '';
            excelFileInput.value = '';
            searchInput.value = '';
            hideError();
            hideResults();

            // Re-enable import buttons
            importBtn.classList.remove('disabled');
            importBtn.style.pointerEvents = '';
            importExcelBtn.classList.remove('disabled');
            importExcelBtn.style.pointerEvents = '';
        }

        discardBtn.addEventListener('click', () => {
            resetUI();
        });

        // Save data for processing via webhook
        saveProcessingBtn.addEventListener('click', async () => {
            if (!allUsers.length) {
                showError('No data loaded to save.');
                return;
            }

            hideError();
            saveProcessingBtn.disabled = true;
            const originalText = saveProcessingBtn.textContent;
            saveProcessingBtn.textContent = 'Saving...';

            try {
                // Get source from first user (all users in the array have the same source)
                const source = allUsers[0]?.source || 'unknown';
                
                // Remove source field from user objects before sending
                const usersWithoutSource = allUsers.map(user => {
                    const { source, ...userData } = user;
                    return userData;
                });

                const response = await fetch(SAVE_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source: source,
                        data: usersWithoutSource
                    })
                });

                let data = null;
                try {
                    data = await response.json();
                } catch (e) {
                    // Ignore JSON parse errors, will fall back to generic error
                }

                if (response.ok && data && data.status === 'success') {
                    alert('Data saved successfully for processing.');
                    resetUI();
                } else {
                    showError('Failed to save data for processing.');
                }
            } catch (e) {
                showError('Failed to save data for processing.');
            } finally {
                saveProcessingBtn.textContent = originalText;
                saveProcessingBtn.disabled = false;
            }
        });

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const isActive = btn.dataset.tab === tabName;
                btn.classList.toggle('active', isActive);
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                const isActive = content.id === 'tab-' + tabName;
                content.classList.toggle('active', isActive);
            });
        }

        // KVS initialization and saving
        function populateKVS() {
            const placeholders = {
                system_prompt_base_agent: 'No Available Data',
                system_prompt_web_search_agent: 'No Available Data',
                daily_processing_limit: '0'
            };

            const kvsData = Array.isArray(window.kvsDataFromN8n) ? window.kvsDataFromN8n : [];

            if (!kvsData.length) {
                KVS_FIELDS.forEach(field => {
                    const el = document.getElementById(field.id);
                    if (!el) return;
                    el.value = '';
                    el.placeholder = placeholders[field.id] || '';
                });
            } else {
                kvsData.forEach(item => {
                    const el = document.getElementById(item.key);
                    if (el) {
                        el.value = item.value;
                        el.placeholder = '';
                    }
                });
            }

            attachKvsEventListeners();
            updateKvsSaveButtonState();
        }

        function attachKvsEventListeners() {
            KVS_FIELDS.forEach(field => {
                const el = document.getElementById(field.id);
                if (!el) return;
                el.addEventListener('input', () => {
                    kvsFieldsEdited = true;
                    updateKvsSaveButtonState();
                });
            });

            saveKvsBtn.addEventListener('click', saveKVS);
        }

        function updateKvsSaveButtonState() {
            saveKvsBtn.disabled = !kvsFieldsEdited;
        }

        function buildKVSPayload() {
            const payload = [];
            KVS_FIELDS.forEach(field => {
                const el = document.getElementById(field.id);
                if (!el) return;
                const value = el.value;
                if (value !== '' && value !== undefined && value !== null) {
                    payload.push({ key: field.key, value });
                }
            });
            return payload;
        }

        async function saveKVS() {
            const payload = buildKVSPayload();
            if (!payload.length) {
                alert('No KVS values to save.');
                return;
            }

            saveKvsBtn.disabled = true;
            const originalText = saveKvsBtnText.textContent;
            saveKvsBtnText.textContent = 'Saving...';

            try {
                const response = await fetch(KVS_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                let data = null;
                try {
                    data = await response.json();
                } catch (e) {
                    // Ignore JSON parse errors, will fall back to generic error
                }

                if (response.ok && data && data.status === 'success') {
                    kvsFieldsEdited = false;
                    saveKvsBtnText.textContent = '‚úÖ Saved Successfully!';
                    setTimeout(() => {
                        saveKvsBtnText.textContent = originalText;
                        updateKvsSaveButtonState();
                    }, 2000);
                } else {
                    throw new Error('Failed to save');
                }
            } catch (e) {
                alert('Failed to save KVS configuration. Please try again.');
                saveKvsBtn.disabled = false;
                saveKvsBtnText.textContent = originalText;
            }
        }

        // Initialize KVS data on load
        populateKVS();

        // ========================================
        // Dashboard Tab Functionality
        // ========================================
        let dashboardData = [];
        let dashboardFilteredData = [];
        let dashboardCurrentPage = 1;
        let dashboardSortDirection = 'desc';
        const dashboardItemsPerPage = 20;

        const dashboardTableBody = document.getElementById('dashboardTableBody');
        const dashboardResultsCount = document.getElementById('dashboardResultsCount');
        const dashboardPaginationContainer = document.getElementById('dashboardPaginationContainer');
        const dashboardPageInfo = document.getElementById('dashboardPageInfo');
        const dashboardFirstBtn = document.getElementById('dashboardFirstBtn');
        const dashboardPrevBtn = document.getElementById('dashboardPrevBtn');
        const dashboardNextBtn = document.getElementById('dashboardNextBtn');
        const dashboardLastBtn = document.getElementById('dashboardLastBtn');
        const modalOverlay = document.getElementById('modalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const orgIdHeader = document.getElementById('orgIdHeader');
        const personIdHeader = document.getElementById('personIdHeader');
        const dealIdHeader = document.getElementById('dealIdHeader');
        const pushHeader = document.getElementById('pushHeader');

        function initializeDashboard() {
            const zendeskData = Array.isArray(window.zendeskDataFromN8n) ? window.zendeskDataFromN8n : [];
            // Filter out empty objects
            dashboardData = zendeskData.filter(item => item && item.id);
            dashboardCurrentPage = 1;
            dashboardSortDirection = 'desc';
            applyDashboardFiltersAndSort();
            setupDashboardEventListeners();
        }

        function getDashboardFilterValues() {
            return {
                search: (document.getElementById('dashboardSearch')?.value || '').toLowerCase(),
                status: document.getElementById('dashboardStatus')?.value || 'all',
                source: document.getElementById('dashboardSource')?.value || 'all',
                shippingVolume: document.getElementById('dashboardShippingVolume')?.value || 'all',
                logisticsType: document.getElementById('dashboardLogisticsType')?.value || 'all',
                scoreMin: parseFloat(document.getElementById('dashboardScoreMin')?.value || 0),
                scoreMax: parseFloat(document.getElementById('dashboardScoreMax')?.value || 10)
            };
        }

        function filterDashboardItem(item, filters) {
            // Search filter (name, email, phone)
            if (filters.search) {
                const searchFields = [
                    item.customer_name || '',
                    item.email || '',
                    item.phone || ''
                ].map(f => f.toLowerCase());
                if (!searchFields.some(field => field.includes(filters.search))) return false;
            }

            // Status filter
            if (filters.status !== 'all' && item.status !== filters.status) return false;

            // Source filter
            if (filters.source !== 'all' && (item.source || 'zendesk') !== filters.source) return false;

            // Shipping volume filter
            if (filters.shippingVolume !== 'all' && item.estimated_shipping_volume !== filters.shippingVolume) return false;

            // Logistics type filter
            if (filters.logisticsType !== 'all' && item.likely_logistics_type !== filters.logisticsType) return false;

            // Lead score range filter
            const leadScore = item.lead_score || 0;
            if (leadScore < filters.scoreMin || leadScore > filters.scoreMax) return false;

            return true;
        }

        function applyDashboardFiltersAndSort() {
            const filters = getDashboardFilterValues();
            dashboardFilteredData = dashboardData.filter(item => filterDashboardItem(item, filters));
            
            sortDashboardData();
            dashboardCurrentPage = 1;
            renderDashboardTable();
        }

        function sortDashboardData() {
            const sortField = document.getElementById('dashboardSortField')?.value || 'createdAt';
            
            dashboardFilteredData.sort((a, b) => {
                let aVal = a[sortField];
                let bVal = b[sortField];

                if (sortField === 'createdAt') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }

                const comparison = aVal > bVal ? 1 : -1;
                return dashboardSortDirection === 'asc' ? comparison : -comparison;
            });
        }

        function toggleDashboardSort() {
            dashboardSortDirection = dashboardSortDirection === 'asc' ? 'desc' : 'asc';
            const sortDirectionEl = document.getElementById('dashboardSortDirection');
            if (sortDirectionEl) {
                sortDirectionEl.textContent = dashboardSortDirection === 'asc' ? '‚Üë' : '‚Üì';
            }
            applyDashboardFiltersAndSort();
        }

        function updateDashboardScoreDisplay() {
            const min = document.getElementById('dashboardScoreMin')?.value || 0;
            const max = document.getElementById('dashboardScoreMax')?.value || 10;
            const display = document.getElementById('dashboardScoreDisplay');
            if (display) {
                display.textContent = `${min} - ${max}`;
            }
        }

        function resetDashboardFilters() {
            const searchEl = document.getElementById('dashboardSearch');
            const statusEl = document.getElementById('dashboardStatus');
            const sourceEl = document.getElementById('dashboardSource');
            const shippingVolEl = document.getElementById('dashboardShippingVolume');
            const logisticsEl = document.getElementById('dashboardLogisticsType');
            const scoreMinEl = document.getElementById('dashboardScoreMin');
            const scoreMaxEl = document.getElementById('dashboardScoreMax');

            if (searchEl) searchEl.value = '';
            if (statusEl) statusEl.value = 'all';
            if (sourceEl) sourceEl.value = 'all';
            if (shippingVolEl) shippingVolEl.value = 'all';
            if (logisticsEl) logisticsEl.value = 'all';
            if (scoreMinEl) scoreMinEl.value = '0';
            if (scoreMaxEl) scoreMaxEl.value = '10';
            
            updateDashboardScoreDisplay();
            applyDashboardFiltersAndSort();
        }

        function setupDashboardEventListeners() {
            const searchEl = document.getElementById('dashboardSearch');
            const statusEl = document.getElementById('dashboardStatus');
            const sourceEl = document.getElementById('dashboardSource');
            const shippingVolEl = document.getElementById('dashboardShippingVolume');
            const logisticsEl = document.getElementById('dashboardLogisticsType');
            const scoreMinEl = document.getElementById('dashboardScoreMin');
            const scoreMaxEl = document.getElementById('dashboardScoreMax');
            const sortFieldEl = document.getElementById('dashboardSortField');
            const sortBtn = document.getElementById('dashboardSortBtn');
            const resetBtn = document.getElementById('dashboardResetFiltersBtn');

            if (searchEl) {
                searchEl.addEventListener('input', applyDashboardFiltersAndSort);
            }
            if (statusEl) {
                statusEl.addEventListener('change', applyDashboardFiltersAndSort);
            }
            if (sourceEl) {
                sourceEl.addEventListener('change', applyDashboardFiltersAndSort);
            }
            if (shippingVolEl) {
                shippingVolEl.addEventListener('change', applyDashboardFiltersAndSort);
            }
            if (logisticsEl) {
                logisticsEl.addEventListener('change', applyDashboardFiltersAndSort);
            }
            if (scoreMinEl) {
                scoreMinEl.addEventListener('input', () => {
                    updateDashboardScoreDisplay();
                    applyDashboardFiltersAndSort();
                });
            }
            if (scoreMaxEl) {
                scoreMaxEl.addEventListener('input', () => {
                    updateDashboardScoreDisplay();
                    applyDashboardFiltersAndSort();
                });
            }
            if (sortFieldEl) {
                sortFieldEl.addEventListener('change', applyDashboardFiltersAndSort);
            }
            if (sortBtn) {
                sortBtn.addEventListener('click', toggleDashboardSort);
            }
            if (resetBtn) {
                resetBtn.addEventListener('click', resetDashboardFilters);
            }
        }

        function renderDashboardTable() {
            if (!dashboardData.length || (dashboardData.length === 1 && !dashboardData[0].id)) {
                dashboardTableBody.innerHTML = '<tr><td colspan="13" class="no-results">No data available</td></tr>';
                dashboardResultsCount.textContent = 'No data available';
                dashboardPaginationContainer.style.display = 'none';
                orgIdHeader.style.display = 'none';
                personIdHeader.style.display = 'none';
                dealIdHeader.style.display = 'none';
                pushHeader.style.display = 'none';
                return;
            }

            if (!dashboardFilteredData.length) {
                dashboardTableBody.innerHTML = '<tr><td colspan="13" class="no-results">No results found</td></tr>';
                dashboardResultsCount.textContent = `Showing 0 of ${dashboardData.length} leads`;
                dashboardPaginationContainer.style.display = 'none';
                orgIdHeader.style.display = 'none';
                personIdHeader.style.display = 'none';
                dealIdHeader.style.display = 'none';
                pushHeader.style.display = 'none';
                return;
            }

            const startIndex = (dashboardCurrentPage - 1) * dashboardItemsPerPage;
            const pageData = dashboardFilteredData.slice(startIndex, startIndex + dashboardItemsPerPage);

            // Determine if we have queued items (to show push button)
            const hasQueued = dashboardFilteredData.some(item => item.status === 'queued');

            // Always hide org_id, person_id, and deal_id columns
            orgIdHeader.style.display = 'none';
            personIdHeader.style.display = 'none';
            dealIdHeader.style.display = 'none';
            pushHeader.style.display = hasQueued ? 'table-cell' : 'none';

            dashboardTableBody.innerHTML = pageData.map(item => createDashboardRow(item)).join('');

            updateDashboardPagination();
        }

        function createDashboardRow(item) {
            const isProcessed = item.status === 'processed';
            const leadScore = `<span class="lead-score">${(item.lead_score || 0).toFixed(1)}</span>`;
            // Convert UTC to Europe/Berlin timezone
            const createdAt = new Date(item.createdAt).toLocaleDateString('nl-NL', { timeZone: 'Europe/Berlin' });
            const shippingVol = item.estimated_shipping_volume || 'N/A';
            const logistics = item.likely_logistics_type || 'N/A';

            // Status cell: if processed and has deal_id, show as link, otherwise show badge
            let statusCell = '';
            if (isProcessed && item.deal_id) {
                statusCell = `<a href="https://verpakkingenxl.pipedrive.com/deal/${item.deal_id}" class="deal-link" onclick="openDealLink('https://verpakkingenxl.pipedrive.com/deal/${item.deal_id}', event); return false;">Processed</a>`;
            } else {
                const statusText = item.status.charAt(0).toUpperCase() + item.status.slice(1);
                statusCell = `<span class="status-badge status-${item.status}">${statusText}</span>`;
            }

            let pushCell = '';
            if (isProcessed) {
                pushCell = '<td><span class="pushed-badge">Pushed</span></td>';
            } else {
                pushCell = `<td><button class="push-btn" onclick="pushToPipedrive(${item.id}, event)">Push to Pipedrive</button></td>`;
            }

            // Make customer name a link to organization if processed
            let customerNameCell = item.customer_name || 'N/A';
            if (isProcessed && item.org_id) {
                customerNameCell = `<a href="https://verpakkingenxl.pipedrive.com/organization/${item.org_id}" class="deal-link" onclick="openDealLink('https://verpakkingenxl.pipedrive.com/organization/${item.org_id}', event); return false;">${item.customer_name || 'N/A'}</a>`;
            }

            return `<tr onclick="openDashboardModal(${item.id})">
                <td>${customerNameCell}</td>
                <td>${item.email || '‚Äî'}</td>
                <td>${item.phone || '‚Äî'}</td>
                <td>${shippingVol}</td>
                <td>${logistics}</td>
                <td>${leadScore}</td>
                <td>${item.source || 'zendesk'}</td>
                <td>${statusCell}</td>
                <td>${createdAt}</td>
                ${pushCell}
            </tr>`;
        }

        function updateDashboardPagination() {
            const totalPages = Math.ceil(dashboardFilteredData.length / dashboardItemsPerPage);
            const startIdx = (dashboardCurrentPage - 1) * dashboardItemsPerPage;
            const endIdx = Math.min(startIdx + dashboardItemsPerPage, dashboardFilteredData.length);

            dashboardPageInfo.textContent = `Page ${dashboardCurrentPage} of ${totalPages}`;
            dashboardResultsCount.textContent = `Showing ${startIdx + 1}-${endIdx} of ${dashboardFilteredData.length} leads (${dashboardData.length} total)`;

            const isFirstPage = dashboardCurrentPage === 1;
            const isLastPage = dashboardCurrentPage === totalPages;

            dashboardFirstBtn.disabled = dashboardPrevBtn.disabled = isFirstPage;
            dashboardNextBtn.disabled = dashboardLastBtn.disabled = isLastPage;

            dashboardPaginationContainer.style.display = totalPages > 1 ? 'flex' : 'none';
        }

        function goToDashboardPage(pageNumber) {
            const totalPages = Math.ceil(dashboardFilteredData.length / dashboardItemsPerPage);
            if (pageNumber >= 1 && pageNumber <= totalPages) {
                dashboardCurrentPage = pageNumber;
                renderDashboardTable();
            }
        }

        dashboardFirstBtn.addEventListener('click', () => goToDashboardPage(1));
        dashboardPrevBtn.addEventListener('click', () => goToDashboardPage(dashboardCurrentPage - 1));
        dashboardNextBtn.addEventListener('click', () => goToDashboardPage(dashboardCurrentPage + 1));
        dashboardLastBtn.addEventListener('click', () => goToDashboardPage(Math.ceil(dashboardFilteredData.length / dashboardItemsPerPage)));

        function openDashboardModal(id) {
            const item = dashboardData.find(d => d.id === id);
            if (!item) return;

            modalTitle.textContent = item.customer_name || 'Lead Details';
            modalBody.innerHTML = createDashboardModalContent(item);
            modalOverlay.classList.add('active');
        }

        function createDashboardModalContent(item) {
            const isProcessed = item.status === 'processed';
            const statusBadge = `<span class="status-badge status-${item.status}">${item.status.charAt(0).toUpperCase() + item.status.slice(1)}</span>`;

            let statusSection = `<div class="modal-field"><label>Status</label><div class="value">${statusBadge}</div></div>`;

            if (isProcessed) {
                if (item.org_id) {
                    statusSection += `<div class="modal-field"><label>Organization Link</label><div class="value"><a href="https://verpakkingenxl.pipedrive.com/organization/${item.org_id}" class="deal-link" onclick="openDealLink('https://verpakkingenxl.pipedrive.com/organization/${item.org_id}', event); return false;">View Organization ‚Üó</a></div></div>`;
                }
                if (item.person_id) {
                    statusSection += `<div class="modal-field"><label>Person Link</label><div class="value"><a href="https://verpakkingenxl.pipedrive.com/person/${item.person_id}" class="deal-link" onclick="openDealLink('https://verpakkingenxl.pipedrive.com/person/${item.person_id}', event); return false;">View Person ‚Üó</a></div></div>`;
                }
                if (item.deal_id) {
                    statusSection += `<div class="modal-field"><label>Deal Link</label><div class="value"><a href="https://verpakkingenxl.pipedrive.com/deal/${item.deal_id}" class="deal-link" onclick="openDealLink('https://verpakkingenxl.pipedrive.com/deal/${item.deal_id}', event); return false;">View Deal ‚Üó</a></div></div>`;
                }
            }

            return `
                <div class="modal-section">
                    <h3>Status & Deal Information</h3>
                    <div class="modal-grid">${statusSection}</div>
                </div>
                <div class="modal-section">
                    <h3>Customer Information</h3>
                    <div class="modal-grid">
                        <div class="modal-field"><label>Zendesk ID</label><div class="value">${item.zendesk_id || 'N/A'}</div></div>
                        <div class="modal-field"><label>Customer Name</label><div class="value">${item.customer_name || 'N/A'}</div></div>
                        <div class="modal-field"><label>Email</label><div class="value">${item.email || '‚Äî'}</div></div>
                        <div class="modal-field"><label>Phone</label><div class="value">${item.phone || '‚Äî'}</div></div>
                        <div class="modal-field"><label>Address</label><div class="value">${item.address || '‚Äî'}</div></div>
                        <div class="modal-field"><label>Locale</label><div class="value">${item.locale || '‚Äî'}</div></div>
                        <div class="modal-field"><label>Source</label><div class="value">${item.source || 'zendesk'}</div></div>
                    </div>
                </div>
                <div class="modal-section">
                    <h3>AI Analysis</h3>
                    <div class="modal-grid">
                        <div class="modal-field"><label>Decision</label><div class="value">${item.decision || 'N/A'}</div></div>
                        <div class="modal-field"><label>Lead Score</label><div class="value"><span class="lead-score">${(item.lead_score || 0).toFixed(1)}</span></div></div>
                        <div class="modal-field"><label>Estimated Shipping Volume</label><div class="value">${item.estimated_shipping_volume || 'N/A'}</div></div>
                        <div class="modal-field"><label>Likely Logistics Type</label><div class="value">${item.likely_logistics_type || 'N/A'}</div></div>
                        <div class="modal-field full-width"><label>Reason</label><div class="value long-text">${item.reason || 'N/A'}</div></div>
                        <div class="modal-field full-width"><label>Compact Instruction</label><div class="value long-text">${item.compact_instruction || 'N/A'}</div></div>
                    </div>
                </div>
                <div class="modal-section">
                    <h3>Created At</h3>
                    <div class="modal-grid">
                        <div class="modal-field"><label>Timestamp</label><div class="value">${new Date(item.createdAt).toLocaleString('nl-NL', { timeZone: 'Europe/Berlin', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' })}</div></div>
                    </div>
                </div>
            `;
        }

        function closeModal() {
            modalOverlay.classList.remove('active');
        }

        function closeModalOnOverlay(event) {
            if (event.target.id === 'modalOverlay') {
                closeModal();
            }
        }

        function openDealLink(url, event) {
            event.stopPropagation();
            const link = document.createElement('a');
            link.href = url;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            document.body.appendChild(link);
            const clickEvent = new MouseEvent('click', {
                bubbles: true,
                cancelable: true,
                view: window,
                ctrlKey: true,
                metaKey: true
            });
            link.dispatchEvent(clickEvent);
            document.body.removeChild(link);
        }

        async function pushToPipedrive(id, event) {
            event.stopPropagation();
            const item = dashboardData.find(d => d.id === id);
            if (!item) return;

            const button = event.target;
            button.disabled = true;
            const originalText = button.textContent;
            button.textContent = 'Pushing...';

            try {
                const response = await fetch(PUSH_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(item)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const responseData = await response.json();

                // Update the item in dashboardData with the response data
                const itemIndex = dashboardData.findIndex(d => d.id === id);
                if (itemIndex !== -1) {
                    dashboardData[itemIndex] = {
                        ...dashboardData[itemIndex],
                        org_id: responseData.org_id ?? null,
                        person_id: responseData.person_id ?? null,
                        deal_id: responseData.deal_id ?? null,
                        note_id: responseData.note_id ?? null,
                        status: 'processed'
                    };
                }

                // Re-apply filters and re-render the table
                applyDashboardFiltersAndSort();
            } catch (e) {
                alert('Failed to push to Pipedrive: ' + (e.message || 'Unknown error'));
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        // ========================================
        // Initialize Application with Auth Check
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            if (auth.checkAuth()) {
                initializeApp();
            }
        });
    </script>
</body>

</html>